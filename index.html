<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>IRON BANK POOLS</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <style>
    
body {
  font-family: 'Segoe UI', sans-serif;
  background: #121212;
  color: #e0e0e0;
  padding: 20px;
  margin: 0;
  overflow-x: hidden;
}

h1 {
  text-align: center;
  color: #fff;
  margin-bottom: 10px;
}

#portfolio-summary,
#credit-usage,
#predicted-usage,
#wallet-status {
  text-align: center;
  margin: 10px 0;
  font-weight: bold;
}

.button-group {
  text-align: center;
  margin-bottom: 15px;
}

.table-wrapper {
  overflow-x: auto;
  width: 100%;
  max-width: 100%;
}

table {
  width: 100%;
  border-collapse: collapse;
  background: #1e1e1e;
  margin-top: 20px;
  table-layout: auto;
}

th, td {
  border: 1px solid #333;
  padding: 8px 12px;
  text-align: left;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  color: #e0e0e0;
  font-size: 14px;
}

th {
  background: #2c2c2c;
  font-weight: bold;
}

tr:nth-child(even) {
  background: #252525;
}

td[data-label="Actions"] {
  min-width: 160px;
  max-width: 180px;
  white-space: normal;
  word-break: break-word;
  padding: 6px;
}

td[data-label="Actions"] button,
td[data-label="Actions"] input {
  font-size: 12px;
  padding: 4px 6px;
  margin: 2px 0;
  width: 100%;
  box-sizing: border-box;
}

input {
  background: #2c2c2c;
  color: #e0e0e0;
  border: 1px solid #444;
  border-radius: 4px;
  padding: 4px;
  margin: 2px 0;
  width: 80px;
  max-width: 100%;
  box-sizing: border-box;
}

.liquidity-value { color: #2ecc71; }
.supply-apy, .pred-supply { color: yellow; white-space: nowrap; }
.borrow-apy, .pred-borrow { color: #e74c3c; white-space: nowrap; }
.your-lend, .your-borrow { color: #9b59b6; font-weight: bold; }

button {
  background: #3b82f6;
  border: none;
  color: #fff;
  padding: 6px 10px;
  margin: 2px;
  border-radius: 4px;
  cursor: pointer;
}

button:hover {
  background: #2563eb;
}

.progress-container {
  background: #333;
  border-radius: 4px;
  width: 80%;
  height: 12px;
  margin: 4px auto;
}

.progress-bar {
  height: 100%;
  width: 0;
  border-radius: 4px;
  transition: width 0.3s, background-color 0.3s;
}

/* Mobile responsive styles */
@media (max-width: 800px) {
  body { padding: 5px; }

  table, thead, tbody, th, td, tr {
    display: block;
    width: 100%;
  }

  thead { display: none; }

  tr {
    margin-bottom: 15px;
    border-bottom: 2px solid #333;
  }

  td {
    border: none;
    position: relative;
    padding-left: 50%;
    box-sizing: border-box;
    white-space: normal !important;
    overflow: visible !important;
    text-overflow: unset !important;
  }

  td:before {
    position: absolute;
    left: 10px;
    top: 12px;
    width: 45%;
    white-space: nowrap;
    font-weight: bold;
    color: #aaa;
    content: attr(data-label);
  }

  td[data-label="Actions"] {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
    justify-content: flex-start;
    padding-left: 10px;
  }

  td[data-label="Actions"] button {
    min-width: 90px;
    font-size: 0.9em;
    flex: 1 1 auto;
  }

  .button-group button,
  input {
    width: 95%;
    margin: 4px 0;
  }

  #portfolio-summary,
  #credit-usage,
  #predicted-usage {
    font-size: 1em;
  }
}

</style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  

</head>
<body>
  <h1>IRON BANK POOLS</h1>
  <div id="portfolio-summary">Portfolio: $0.00 | Net APY: 0% | Daily: $0.00 | Hourly: $0.00</div>
  <div id="credit-usage">Credit Usage: 0% of max<div class="progress-container"><div id="usage-bar" class="progress-bar"></div></div></div>
  <div id="predicted-usage">Predicted Usage: N/A<div class="progress-container"><div id="predicted-bar" class="progress-bar"></div></div></div>
  <div id="wallet-status"></div>
  <div class="button-group">
    <button onclick="connectWallet()">Connect Wallet</button>
    <button onclick="disconnectWallet()">Disconnect Wallet</button>
    <button onclick="loadPoolData()">Refresh Data</button>
    <button onclick="previewAll()">Preview All</button>
  </div>
 <div class="table-wrapper">
  <table>
    <thead>
      <tr>
        <th>Token</th>
        <th>Liquidity</th>
        <th>Total Supply</th>
        <th>Supply APY</th>
        <th>Total Borrow</th>
        <th>Borrow APY</th>
        <th>Reserves</th>
        <th>Utilization</th>
        <th>Your Lend</th>
        <th>Your Borrow</th>
        <th>Actions</th>
        <th>Collateral</th>
      </tr>
    </thead>
    <tbody id="data-body"></tbody>
  </table>
  </div>
  <div id="status"></div>
  <div id="history-section" style="margin-top: 30px;"></div>

  <script>
    const blocksPerYear = 2628000;
    let provider, signer;
    const GREEN='#2ecc71', RED='#e74c3c';
window.dashboardState = {
  totalLendUSD: 0,
  totalBorrowUSD: 0,
  totalCapacityUSD: 0,
  weightedSupply: 0,
  weightedBorrow: 0,
  poolStats: {},
  ethPriceUSD: 0
};
    const pools=[
      {name:'USDT',address:'0x48759F220ED983dB51fA7A8C0D2AAb8f3ce4166a',decimals:6,collateralFactor:0.90},
      {name:'DAI', address:'0x8e595470Ed749b85C6F7669de83EAe304C2ec68F',decimals:18,collateralFactor:0.80},
      {name:'USDC',address:'0x76Eb2FE28b36B3ee97F3Adae0C69606eeDB2A37c',decimals:6,collateralFactor:0.90},
      {name:'ETH', address:'0x41c84c0e2EE0b740Cf0d31F63f3B6F627DC6b393',decimals:18,collateralFactor:0.75}
    ];

    function setStatus(msg){ document.getElementById('status').innerText = msg; }
    function updateUsage(cur,pred){
      const u = document.getElementById('usage-bar'); u.style.width = cur+'%'; u.style.background = cur<=90?GREEN:RED;
      document.getElementById('credit-usage').firstChild.nodeValue = `Credit Usage: ${cur.toFixed(2)}% of max`;
      const pb = document.getElementById('predicted-bar'); pb.style.width = pred+'%'; pb.style.background = pred<=90?GREEN:RED;
      document.getElementById('predicted-usage').firstChild.nodeValue = `Predicted Usage: ${pred.toFixed(2)}% of max`;
    }
    function clearPredAPY(){ pools.forEach(p=>{
      const s=document.getElementById(`pred-supply-${p.address}`), b=document.getElementById(`pred-borrow-${p.address}`);
      if(s) s.textContent=''; if(b) b.textContent='';
    }); }
    function updatePredAPY(addr, sAPY, bAPY) {
  const sp = document.getElementById(`pred-supply-${addr}`);
  sp.classList.add('pred-supply');
  if (isNaN(sAPY)) {
    sp.innerHTML = '';
  } else {
    sp.innerHTML = `&nbsp;‚Üí ${(sAPY*100).toFixed(2)}%`;
  }
  const bp = document.getElementById(`pred-borrow-${addr}`);
  bp.classList.add('pred-borrow');
  if (isNaN(bAPY)) {
    bp.innerHTML = '';
  } else {
    bp.innerHTML = `&nbsp;‚Üí ${(bAPY*100).toFixed(2)}%`;
  }
}

    async function connectWallet(){
      if(!window.ethereum){ setStatus('‚ùå MetaMask not installed'); return; }
      provider = new ethers.providers.Web3Provider(window.ethereum);
      await provider.send('eth_requestAccounts', []);
      signer = provider.getSigner();
      const raw = await signer.getAddress();
      const masked = raw.slice(0,6) + '***' + raw.slice(-4);
      document.getElementById('wallet-status').innerHTML = `<span style="color:#34d399">Connected: ${masked}</span>`;
      loadPoolData();
    }
    function disconnectWallet(){
      provider = signer = null;
      window.dashboardState = { totalLendUSD:0, totalBorrowUSD:0, totalCapacityUSD:0, weightedSupply:0, weightedBorrow:0, poolStats:{} };
      document.getElementById('wallet-status').innerText = '';
      document.getElementById('data-body').innerHTML = '';
      document.getElementById('portfolio-summary').innerText = 'Portfolio: $0.00 | Net APY: 0% | Daily: $0.00 | Hourly: $0.00';
      updateUsage(0,0); clearPredAPY(); setStatus('');
    }

    async function loadPoolData(){
      if(!signer){ setStatus('‚ùå Connect wallet first'); return; }
      setStatus('üîÑ Loading‚Ä¶');
      await fetchEthPriceUSD();

      const user = await signer.getAddress();

      const abi=[
        "function getCash() view returns(uint256)",
        "function totalBorrows() view returns(uint256)",
        "function totalReserves() view returns(uint256)",
        "function borrowRatePerBlock() view returns(uint256)",
        "function supplyRatePerBlock() view returns(uint256)",
        "function exchangeRateStored() view returns(uint256)",
        "function balanceOf(address) view returns(uint256)",
        "function borrowBalanceStored(address) view returns(uint256)",
        "function interestRateModel() view returns(address)",
        "function reserveFactorMantissa() view returns(uint256)"
      ];
      let totL=0, totB=0, totC=0, wS=0, wB=0;
      let assetsIn = [];
      try {
        assetsIn = (await getAssetsIn(user)).map(a => a.toLowerCase());
      } catch (e) {
        assetsIn = pools.map(p => p.address.toLowerCase());
      }
    }

      const tbody = document.getElementById('data-body');
      tbody.innerHTML = ''; // –û–ß–ò–°–¢–ò–¢–¨ –ü–ï–†–ï–î –î–û–ë–ê–í–õ–ï–ù–ò–ï–ú –°–¢–†–û–ö

      for(const p of pools) {
        try {
          const c = new ethers.Contract(p.address, abi, provider);
          const [cash, borrows, reserves, brRaw, srRaw, exRate, cBal, bBal, modelAddr, resFact] =
            await Promise.all([
              c.getCash(), c.totalBorrows(), c.totalReserves(),
              c.borrowRatePerBlock(), c.supplyRatePerBlock(),
              c.exchangeRateStored(), c.balanceOf(user),
              c.borrowBalanceStored(user),
              c.interestRateModel(), c.reserveFactorMantissa()
            ]);
          const brPB = parseFloat(ethers.utils.formatUnits(brRaw,18));
          const srPB = parseFloat(ethers.utils.formatUnits(srRaw,18));
          const rf = parseFloat(ethers.utils.formatUnits(resFact,18));
          const borrowAPY = (1+brPB)**blocksPerYear - 1;
          const supplyAPY = (1+srPB)**blocksPerYear - 1;
          const totalSupply = cash.add(borrows).sub(reserves);
          const utilization = borrows.mul(10000).div(totalSupply).toNumber()/100;
          let usdLend = parseFloat(ethers.utils.formatUnits(
            cBal.mul(exRate).div(ethers.BigNumber.from("1000000000000000000")),
            p.decimals
          ));
          let usdBorrow = parseFloat(ethers.utils.formatUnits(bBal, p.decimals));
          if (p.name === 'ETH') {
            const ethPrice = window.dashboardState.ethPriceUSD;
            usdLend *= ethPrice;
            usdBorrow *= ethPrice;
          }
          totL+=usdLend; totB+=usdBorrow;
          if (assetsIn.includes(p.address.toLowerCase()) && usdLend > 0) {
            totC+=usdLend*p.collateralFactor;
          }
          wS+=usdLend*supplyAPY; wB+=usdBorrow*borrowAPY;
          window.dashboardState.poolStats[p.address] = {
            cash, borrows, reserves, modelAddr, resFact,
            brPB, srPB, rf,
            supplyAPY, borrowAPY,
            util: utilization/100,
            decimals: p.decimals,
            collateralFactor: p.collateralFactor
          };
          const fmt = v => Number(ethers.utils.formatUnits(v, p.decimals)).toLocaleString(undefined, {
            maximumFractionDigits: 2
          });
          const usdFmt = (v) => `$${v.toLocaleString(undefined, {maximumFractionDigits: 2})}`;
          const fmtWithUSD = (valBN, valUSD) => {
            const native = Number(ethers.utils.formatUnits(valBN, p.decimals)).toFixed(4);
            return p.name === 'ETH'
              ? `${native} ${p.name}<br/><small style="color:#aaa">(${usdFmt(valUSD)})</small>`
              : `${usdFmt(valUSD)} ${p.name}`;
          };
          const borrowText = p.name === 'ETH'
            ? `${parseFloat(ethers.utils.formatUnits(bBal, p.decimals)).toFixed(4)} ${p.name}<br/><small style="color:#aaa">($${usdBorrow.toLocaleString(undefined,{maximumFractionDigits:2})})</small>`
            : `${usdBorrow.toLocaleString(undefined,{maximumFractionDigits:2})} ${p.name}`;

          // --- Collateral indication and enable button ---
          const isCollateral = assetsIn.includes(p.address.toLowerCase());
          const collateralCell = isCollateral
            ? '<span style="color:#2ecc71;font-weight:bold;">‚úî Enabled</span>'
            : `<button onclick="enableCollateral('${p.address}')">Enable</button>`;

          const row = document.createElement('tr');
          row.innerHTML = `
            <td data-label="Token">${p.name}</td>
            <td data-label="Liquidity" class="liquidity-value">${fmtWithUSD(cash, p.name === 'ETH' ? parseFloat(ethers.utils.formatUnits(cash, p.decimals)) * window.dashboardState.ethPriceUSD : parseFloat(ethers.utils.formatUnits(cash, p.decimals)))}</td>
            <td data-label="Total Supply">${fmtWithUSD(totalSupply, p.name === 'ETH' ? parseFloat(ethers.utils.formatUnits(totalSupply, p.decimals)) * window.dashboardState.ethPriceUSD : parseFloat(ethers.utils.formatUnits(totalSupply, p.decimals)))}</td>
            <td data-label="Supply APY" class="supply-apy">${(supplyAPY*100).toFixed(2)}% <em id="pred-supply-${p.address}"></em></td>
            <td data-label="Total Borrow">${fmtWithUSD(borrows, p.name === 'ETH' ? parseFloat(ethers.utils.formatUnits(borrows, p.decimals)) * window.dashboardState.ethPriceUSD : parseFloat(ethers.utils.formatUnits(borrows, p.decimals)))}</td>
            <td data-label="Borrow APY" class="borrow-apy">${(borrowAPY*100).toFixed(2)}% <em id="pred-borrow-${p.address}"></em></td>
            <td data-label="Reserves">${fmtWithUSD(reserves, p.name === 'ETH' ? parseFloat(ethers.utils.formatUnits(reserves, p.decimals)) * window.dashboardState.ethPriceUSD : parseFloat(ethers.utils.formatUnits(reserves, p.decimals)))}</td>
            <td data-label="Utilization">${utilization.toFixed(2)}%</td>
            <td data-label="Your Lend" class="your-lend">${fmtWithUSD(cBal.mul(exRate).div("1000000000000000000"), usdLend)}</td>
            <td data-label="Your Borrow" class="your-borrow">${borrowText}</td>
            <td data-label="Actions">
              <input id="supply-${p.address}" placeholder="Supply"/><button onclick="supply('${p.address}',${p.decimals})">Supply</button><br/>
              <input id="withdraw-${p.address}" placeholder="Redeem"/><button onclick="withdraw('${p.address}',${p.decimals})">Redeem</button><br/>
              <input id="borrow-${p.address}" placeholder="Borrow"/><button onclick="borrow('${p.address}',${p.decimals})">Borrow</button><br/>
              <input id="repay-${p.address}" placeholder="Repay"/><button onclick="repay('${p.address}',${p.decimals})">Repay</button><br/>
              <button onclick="preview('${p.address}')">Preview</button>
              <button onclick="updatePool('${p.address}')">Update</button>
            </td>
            <td data-label="Collateral">${collateralCell}</td>`;

tbody.appendChild(row);
        }catch(e){ console.error(e); }}
      const myNet = totL - totB;
      const netAPY = myNet !== 0 ? (wS - wB) / Math.abs(myNet) : 0;
      const daily = myNet * netAPY / 365;
      const hourly = daily / 24;
      
    const liquidationIncentive = 1.05; // –∏–ª–∏ –ø–æ–ª—É—á–∏—Ç–µ –∏–∑ Comptroller, –µ—Å–ª–∏ —Ö–æ—Ç–∏—Ç–µ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏
    const realBorrowLimit = borrowLimit / liquidationIncentive;
    const borrowAvailable = Math.max(realBorrowLimit - totB, 0);
    const usage = realBorrowLimit > 0 ? (totB / realBorrowLimit) * 100 : 0;
      document.getElementById('portfolio-summary').innerText =
        `Portfolio: $${myNet.toFixed(2)} | Net APY: ${(netAPY*100).toFixed(2)}% | Daily: $${daily.toFixed(2)} | Hourly: $${hourly.toFixed(2)} | Borrow Available: $${borrowAvailable.toFixed(2)}`;
      updatePredictedPortfolio(myNet, netAPY, daily, hourly);
      window.dashboardState.totalLendUSD = totL;
      window.dashboardState.totalBorrowUSD = totB;
      window.dashboardState.totalCapacityUSD = borrowLimit;
      
      // –ò—Å–ø–æ–ª—å–∑—É–µ–º usage –≤–º–µ—Å—Ç–æ curPct:
      updateUsage(usage, usage);
      clearPredAPY(); setStatus('');
      try {
  const history = JSON.parse(localStorage.getItem("earnHistory") || "[]");
  history.push({
    date: new Date().toISOString(),
    net: myNet.toFixed(2),
    daily: daily.toFixed(2),
    apy: (netAPY * 100).toFixed(2)
  });
  localStorage.setItem("earnHistory", JSON.stringify(history.slice(-30))); // –ø–æ—Å–ª–µ–¥–Ω–∏–µ 30 –∑–∞–ø–∏—Å–µ–π
  renderHistoryTable();
} catch (e) {
  console.warn("Error saving history", e);

    function updatePredictedPortfolio(myNet, netAPY, daily, hourly) {
      let el = document.getElementById('predicted-portfolio');
      if (!el) {
        el = document.createElement('div');
        el.id = 'predicted-portfolio';
        el.style.textAlign = 'center';
        el.style.fontWeight = 'bold';
        el.style.margin = '10px 0';
        el.style.color = '#ffe066';
        document.getElementById('portfolio-summary').after(el);
      }
      el.innerText = `Predicted Portfolio: $${myNet.toFixed(2)} | Net APY: ${(netAPY*100).toFixed(2)}% | Daily: $${daily.toFixed(2)} | Hourly: $${hourly.toFixed(2)}`;
      
    }

    async function preview(addr) {
      const p = pools.find(x => x.address === addr);
      const parseInput = (id, dec) => {
        const el = document.getElementById(id);
        if (!el || !el.value.trim()) return ethers.BigNumber.from(0);
        const val = parseFloat(el.value);
        return !val ? ethers.BigNumber.from(0) : ethers.utils.parseUnits(val.toString(), dec);
      };
      const sup = parseInput(`supply-${addr}`, p.decimals);
      const bor = parseInput(`borrow-${addr}`, p.decimals);
      const rep = parseInput(`repay-${addr}`, p.decimals);
      const wit = parseInput(`withdraw-${addr}`, p.decimals);
      if (sup.isZero() && bor.isZero() && rep.isZero() && wit.isZero()) {
        updatePredAPY(addr, NaN, NaN);
        setStatus('');
        return;
      }
      const stats = window.dashboardState.poolStats[addr];
      let blocksElapsed;
      try {
        const accrual = await new ethers.Contract(addr, ['function accrualBlockNumber() view returns(uint256)'], provider).accrualBlockNumber();
        const curr = await provider.getBlockNumber();
        blocksElapsed = ethers.BigNumber.from(curr).sub(accrual);
        if (blocksElapsed.lt(1)) blocksElapsed = ethers.BigNumber.from(1);
      } catch {
        blocksElapsed = ethers.BigNumber.from(1);
      }
      const brPrev = await new ethers.Contract(stats.modelAddr, ['function getBorrowRate(uint256,uint256,uint256) view returns(uint256)'], provider)
        .getBorrowRate(stats.cash, stats.borrows, stats.reserves);
      const interest = stats.borrows.mul(brPrev).mul(blocksElapsed).div(ethers.utils.parseUnits('1', 18));
      const newBor = stats.borrows.add(interest).add(bor).sub(rep);
      const newCash = stats.cash.add(sup).sub(wit).add(rep).sub(bor);
      const newRes = stats.reserves.add(interest.mul(stats.resFact).div(ethers.utils.parseUnits('1',18)));
      try {
        const im = new ethers.Contract(stats.modelAddr, ['function getBorrowRate(uint256,uint256,uint256) view returns(uint256)', 'function getSupplyRate(uint256,uint256,uint256,uint256) view returns(uint256)'], provider);
        const [brRaw, srRaw] = await Promise.all([
          im.getBorrowRate(newCash, newBor, newRes),
          im.getSupplyRate(newCash, newBor, newRes, stats.resFact)
        ]);
        const brPB = parseFloat(ethers.utils.formatUnits(brRaw, 18));
        const srPB = parseFloat(ethers.utils.formatUnits(srRaw, 18));
        updatePredAPY(addr, (Math.pow(1 + srPB, blocksPerYear) - 1), (Math.pow(1 + brPB, blocksPerYear) - 1));
        setStatus('‚úÖ Preview calculated');
      } catch {
        updatePredAPY(addr, NaN, NaN);
        setStatus('‚ùå Preview error');
      }
    }
 async function previewAll() {
      await fetchEthPriceUSD();
      if (!signer) { setStatus('‚ùå Connect wallet first'); return; }
      setStatus('üîÑ Calculating preview‚Ä¶');
      const user = await signer.getAddress();
      let totL = 0, totB = 0, totC = 0, wS = 0, wB = 0;
      let predL = 0, predB = 0, predC = 0, predWS = 0, predWB = 0;
      let assetsIn = [];
      try {
        assetsIn = (await getAssetsIn(user)).map(a => a.toLowerCase());
      } catch (e) {
        assetsIn = pools.map(p => p.address.toLowerCase());
      }
      for (const pool of pools) {
        const stats = window.dashboardState.poolStats[pool.address];
        // parse user inputs
        const parseInput = (id) => {
          const el = document.getElementById(id);
          if (!el || !el.value.trim()) return ethers.BigNumber.from(0);
          const val = parseFloat(el.value);
          return (isNaN(val) || val <= 0)
            ? ethers.BigNumber.from(0)
            : ethers.utils.parseUnits(val.toString(), pool.decimals);
        };
        const sup = parseInput(`supply-${pool.address}`);
        const bor = parseInput(`borrow-${pool.address}`);
        const rep = parseInput(`repay-${pool.address}`);
        const wit = parseInput(`withdraw-${pool.address}`);

        // current balances
        const c = new ethers.Contract(pool.address, [
          'function balanceOf(address) view returns(uint256)',
          'function borrowBalanceStored(address) view returns(uint256)',
          'function exchangeRateStored() view returns(uint256)'
        ], provider);
        const [cBal, bBal, exRate] = await Promise.all([
          c.balanceOf(user),
          c.borrowBalanceStored(user),
          c.exchangeRateStored()
        ]);
        const usdLend = parseFloat(
          ethers.utils.formatUnits(cBal.mul(exRate).div(ethers.BigNumber.from('1000000000000000000')), pool.decimals)
        );
        const usdBorrow = parseFloat(
          ethers.utils.formatUnits(bBal, pool.decimals)
        );

        totL += usdLend;
        totB += usdBorrow;
if (assetsIn.includes(pool.address.toLowerCase()) && usdLend > 0) {
  totC += usdLend * pool.collateralFactor;
}
        wS += usdLend * stats.supplyAPY;
        wB += usdBorrow * stats.borrowAPY;

        // predicted underlying
        let pL = usdLend;
        if (!sup.isZero()) pL += parseFloat(ethers.utils.formatUnits(sup, pool.decimals));
        if (!wit.isZero()) {
          pL -= parseFloat(ethers.utils.formatUnits(wit, pool.decimals));
          if (pL < 0) pL = 0;
        }
        // borrow –∏ repay –Ω–µ –≤–ª–∏—è—é—Ç –Ω–∞ collateral!
        if (pool.name === 'ETH') {
          const ethPrice = window.dashboardState.ethPriceUSD;
          pL *= ethPrice;
        }
        predL += pL;

        // pB ‚Äî —Ç–æ–ª—å–∫–æ borrow –∏ repay
        let pB = usdBorrow;
        if (!bor.isZero()) pB += parseFloat(ethers.utils.formatUnits(bor, pool.decimals));
        if (!rep.isZero()) {
          pB -= parseFloat(ethers.utils.formatUnits(rep, pool.decimals));
          if (pB < 0) pB = 0;
        }
        if (pool.name === 'ETH') {
          const ethPrice = window.dashboardState.ethPriceUSD;
          pB *= ethPrice;
        }
        predB += pB;

        // –í–∞–∂–Ω–æ: predC += pL * pool.collateralFactor; // —Ç–æ–ª—å–∫–æ supply!
        if (assetsIn.includes(pool.address.toLowerCase()) && usdLend > 0) {
          predC += pL * pool.collateralFactor;
        }


        // interest accrual & new rates
        let blocksElapsed;
        try {
          const accrual = await new ethers.Contract(pool.address,
            ['function accrualBlockNumber() view returns(uint256)'], provider
          ).accrualBlockNumber();
          const curr = await provider.getBlockNumber();
          blocksElapsed = ethers.BigNumber.from(curr).sub(accrual);
          if (blocksElapsed.lt(1)) blocksElapsed = ethers.BigNumber.from(1);
        } catch {
          blocksElapsed = ethers.BigNumber.from(1);
        }
        // accrue interest
        const brPrev = await new ethers.Contract(stats.modelAddr,
          ['function getBorrowRate(uint256,uint256,uint256) view returns(uint256)'], provider
        ).getBorrowRate(stats.cash, stats.borrows, stats.reserves);
        const interest = stats.borrows
          .mul(brPrev)
          .mul(blocksElapsed)
          .div(ethers.utils.parseUnits('1', 18));

        const newBor = stats.borrows.add(interest).add(bor).sub(rep);
        const newCash = stats.cash.add(sup).sub(wit).add(rep).sub(bor);
        const newRes = stats.reserves
          .add(interest.mul(stats.resFact).div(ethers.utils.parseUnits('1',18)));

        try {
          const im = new ethers.Contract(stats.modelAddr, [
            'function getBorrowRate(uint256,uint256,uint256) view returns(uint256)',
            'function getSupplyRate(uint256,uint256,uint256,uint256) view returns(uint256)'
          ], provider);
          const [brRaw, srRaw] = await Promise.all([
            im.getBorrowRate(newCash, newBor, newRes),
            im.getSupplyRate(newCash, newBor, newRes, stats.resFact)
          ]);
          const brPB = parseFloat(ethers.utils.formatUnits(brRaw, 18));
          const srPB = parseFloat(ethers.utils.formatUnits(srRaw, 18));
          const borrowAPYPred = Math.pow(1 + brPB, blocksPerYear) - 1;
          const supplyAPYPred = Math.pow(1 + srPB, blocksPerYear) - 1;
          updatePredAPY(pool.address, supplyAPYPred, borrowAPYPred);
          predWS += pL * supplyAPYPred;
          predWB += pB * borrowAPYPred;
        } catch {}
      }

      // final portfolio prediction
      const myNet = predL - predB;
      const netAPY = myNet ? (predWS - predWB) / Math.abs(myNet) : 0;
      const daily = myNet * netAPY / 365;
      const hourly = daily / 24;
      updatePredictedPortfolio(myNet, netAPY, daily, hourly);

      // usage
const liquidationIncentive = 1.05;
const realBorrowLimitPred = predC / liquidationIncentive;
const predUsage = realBorrowLimitPred > 0 ? (predB / realBorrowLimitPred) * 100 : 0;

const realBorrowLimitCur = window.dashboardState.totalCapacityUSD / liquidationIncentive;
const curUsage = realBorrowLimitCur > 0 ? (window.dashboardState.totalBorrowUSD / realBorrowLimitCur) * 100 : 0;

updateUsage(curUsage, predUsage);
setStatus('‚úÖ Preview all calculated');

    async function supply(addr,dec){
      const val = document.getElementById(`supply-${addr}`).value;
      if(!val) return alert('Enter amount');
      setStatus('‚è≥ Approving & supplying...');
      try{
        const c = new ethers.Contract(addr,
          ["function underlying() view returns(address)", "function mint(uint256) returns(uint256)"],
          signer);
        let underlying;
        try{ underlying = await c.underlying(); }
        catch{
          // USDT cToken uses Tether underlying
          if(addr.toLowerCase()==='0x48759f220ed983db51fa7a8c0d2aab8f3ce4166a'){
            underlying = '0xdAC17F958D2ee523a2206206994597C13D831ec7';
          } else {
            throw new Error('Unable to fetch underlying token address');
          }
        }
        const erc20 = new ethers.Contract(underlying,
          ["function allowance(address,address) view returns(uint256)", "function approve(address,uint256) returns(bool)"],
          signer);
        const owner = await signer.getAddress();
        const amt = ethers.utils.parseUnits(val,dec);
        // Only approve new amount if current allowance is insufficient
        const currentAllowance = await erc20.allowance(owner, addr);
        if(currentAllowance.lt(amt)){
          await (await erc20.approve(addr, amt)).wait();
        }
        // Now mint cTokens
        await (await c.mint(amt)).wait();
        setStatus('‚úÖ Supply done');
        loadPoolData();
      } catch(e){ setStatus('‚ùå '+e.message); }
    }
    async function borrow(addr,dec){
      const val = document.getElementById(`borrow-${addr}`).value;
      if(!val) return alert('Enter amount');
      setStatus('‚è≥ Borrowing...');
      try{
        const c = new ethers.Contract(addr,
          ["function borrow(uint256) returns(uint256)"], signer);
        const amt = ethers.utils.parseUnits(val,dec);
        await (await c.borrow(amt)).wait();
        setStatus('‚úÖ Borrow done');
        loadPoolData();
      } catch(e){ setStatus('‚ùå '+e.message); }
    }
    async function repay(addr,dec){
  const val = document.getElementById(`repay-${addr}`).value;
  if(!val) return alert('Enter amount');
  setStatus('‚è≥ Approving & repaying...');
  try{
    const c = new ethers.Contract(addr,
      ["function repayBorrow(uint256) returns(uint256)", "function underlying() view returns(address)"], signer);
    let underlying;
    try{ underlying = await c.underlying(); }
    catch{ underlying = addr; }
    const erc20 = new ethers.Contract(underlying,
      ["function allowance(address,address) view returns(uint256)", "function approve(address,uint256) returns(bool)"], signer);
    const owner = await signer.getAddress();
    const amt = ethers.utils.parseUnits(val,dec);
    const currentAllowance = await erc20.allowance(owner, addr);
    if(currentAllowance.lt(amt)){
      await (await erc20.approve(addr, amt)).wait();
    }
    await (await c.repayBorrow(amt)).wait();
    setStatus('‚úÖ Repay done');
    loadPoolData();
  } catch(e){ setStatus('‚ùå '+e.message); }
}
    async function withdraw(addr,dec){
      const val = document.getElementById(`withdraw-${addr}`).value;
      if(!val) return alert('Enter amount');
      setStatus('‚è≥ Withdrawing...');
      try{
        const c = new ethers.Contract(addr,
          ["function redeemUnderlying(uint256) returns(uint256)"], signer);
        const amt = ethers.utils.parseUnits(val,dec);
        await (await c.redeemUnderlying(amt)).wait();
        setStatus('‚úÖ Withdraw done');
        loadPoolData();
      } catch(e){ setStatus('‚ùå '+e.message); }
    }
    async function updatePool(addr) {
      setStatus('‚è≥ Updating pool...');
      try {
        const c = new ethers.Contract(addr, ["function accrueInterest() returns (uint256)"], signer);
        await (await c.accrueInterest()).wait();
        setStatus('‚úÖ Pool updated');
        await loadPoolData();
      } catch(e) {
        setStatus('‚ùå ' + (e.reason || e.message));
      }
    }
    async function fetchEthPriceUSD() {
  const priceFeed = new ethers.Contract(
    "0x5f4ec3df9cbd43714fe2740f5e3616155c5b8419", // Chainlink ETH/USD
    ["function latestAnswer() view returns (int256)"],
    provider
  );
  const priceRaw = await priceFeed.latestAnswer();
  const price = parseFloat(ethers.utils.formatUnits(priceRaw, 8));
  window.dashboardState.ethPriceUSD = price;
}
async function getAssetsIn(address) {
  const comptroller = new ethers.Contract(
    "0xAB1c342C7bf5Ec5F02ADEA1c2270670bCa144CbB",
    ["function getAssetsIn(address) view returns (address[])"],
    provider
  );
  return await comptroller.getAssetsIn(address);
}
async function enableCollateral(addr) {
  if (!signer) return setStatus('‚ùå Connect wallet first');
  setStatus('‚è≥ Enabling collateral...');
  try {
    const comptroller = new ethers.Contract(
      "0xAB1c342C7bf5Ec5F02ADEA1c2270670bCa144CbB",
      ["function enterMarkets(address[]) returns (uint256[])"],
      signer
    );
    await (await comptroller.enterMarkets([addr])).wait();
    setStatus('‚úÖ Collateral enabled');
    loadPoolData();
  } catch(e) {
    setStatus('‚ùå ' + (e.reason || e.message));
  }
}
  </script>
</body>
</html>
